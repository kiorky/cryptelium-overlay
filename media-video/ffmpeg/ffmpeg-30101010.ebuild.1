# Distributed under the terms of the GNU General Public License v2
# author: kiorky kiorky@cryptelium.net

inherit subversion fluidcvs eutils flag-o-matic multilib toolchain-funcs

ESVN_REPO_URI="svn://svn.mplayerhq.hu/ffmpeg/trunk"
ESVN_PROJECT="ffmpeg"
ESVN_FETCH_CMD="svn checkout "
ESVN_UPDATE_CMD="svn up -r 5944 "
#ESVN_UPDATE_CMD="svn up -r HEAD "

MY_P=${P/_/-}
S=${WORKDIR}/

DESCRIPTION="Complete solution to record, convert and stream audio and video. Includes libavcodec. (source from CVS)"
HOMEPAGE="http://ffmpeg.sourceforge.net/"
SRC_URI=""
LICENSE="GPL-2"
SLOT="0"
KEYWORDS="-*"
IUSE="aac  x264 xvid faac faad opts pp mp3  a52 altivec debug gpl doc ieee1394 a52 encode imlib mmx ogg vorbis oss test theora threads truetype v4l xvid dts network zlib sdl"

DEPEND="imlib? ( media-libs/imlib2 )
	truetype? ( >=media-libs/freetype-2 )
	sdl? ( >=media-libs/libsdl-1.2.1 )
	doc? ( app-text/texi2html )
	encode? ( media-sound/lame )
	ogg? ( media-libs/libogg )
	vorbis? ( media-libs/libvorbis )
	theora? ( media-libs/libtheora )
	aac? ( media-libs/faad2 media-libs/faac )
	a52? ( >=media-libs/a52dec-0.7.4-r4 )
	xvid? ( >=media-libs/xvid-1.0 )
	zlib? ( sys-libs/zlib )
	dts? ( media-libs/libdts )
	ieee1394? ( =media-libs/libdc1394-1*
	            sys-libs/libraw1394 )
	test? ( net-misc/wget )
	x264? ( media-libs/x264-svn )
	faad? (  media-libs/faad2 )
	xvid? ( media-libs/xvid )
	
	"

src_unpack() {
	subversion_src_unpack
	cd ${S}
}

src_compile() {
	make distclean
	./autogen.sh
	filter-flags -fforce-addr -momit-leaf-frame-pointer
	local myconf=""
	if use "faac"; then 
		myconf="${myconf} --enable-faac"
	fi
	if use "faad"; then 
		myconf="${myconf} --enable-faad"
	fi
	if use "vorbis"; then 
		myconf="${myconf} --enable-vorbis"
	fi
	if use "ogg"; then 
		myconf="${myconf} --enable-libogg"
	fi

	if use "threads"; then 
		myconf="${myconf} --enable-pthreads"
	fi
	if use "pp"; then 
		myconf="${myconf} --enable-pp"
	fi
	if use "a52"; then 
		myconf="${myconf} --enable-a52"
	fi
	if use "xvid"; then 
		myconf="${myconf} --enable-xvid"
	fi
	if use "gpl"; then 
		myconf="${myconf} --enable-gpl"
	fi
	if ! use "opts"; then 
		myconf="${myconf} --disable-opts"
	fi
	if use "ogg"; then 
		myconf="${myconf} --enable-libogg"
	fi
	if use "x264"; then 
		myconf="${myconf} --enable-x264"
	fi
	if use "mp3"; then 
		myconf="${myconf} --enable-mp3lame"
	fi
	./configure --prefix=/usr \
	--mandir=/usr/share/man   \
	--libdir=/usr/lib/ \
	--shlibdir=/usr/lib \
	--incdir=/usr/include \
	--disable-static --enable-shared  ${myconf} || die "Configure failed"

	emake CC="$(tc-getCC)" || die "static failed"
}

src_install() {
	addpredict "/usr"
	addpredict "/usr/lib"
	use doc && make documentation
	
	 cd ${S}
	make DESTDIR="${D}" install  || die "Install Failed"



	dodoc ChangeLog README INSTALL
	dodoc doc/*
	#cd libavcodec/libpostproc
	#make install || die "Failed to install libpostproc.a!"
	# Some stuff like transcode can use this one.
	#dolib ${S}/libavcodec/libpostproc/libpostproc.a
	#preplib /usr
}


